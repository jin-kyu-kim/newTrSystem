<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.trsystem.mybatis.mapper.financialAffairMngMapper">
	
	<!-- 프로젝트 비용청구 현황 -->
    <select id="retrieveAllPrjctList" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT ROW_NUMBER()OVER ()ROWNUM
            , (SELECT CD_NM FROM CD WHERE CD_VALUE = PRJCT_STLE_CD) AS PRJCT_STLE_CD
            , p.PRJCT_ID
            , PRJCT_NM
            , (SELECT CD_NM FROM CD WHERE CD_VALUE = BIZ_STTS_CD) AS BIZ_STTS_CD_NM
            , BIZ_STTS_CD
            , (SELECT EMP_FLNM FROM EMP WHERE EMP_ID = PRJCT_MNGR_EMP_ID ) AS PRJCT_MNGR_EMP_ID
            , (SELECT CTMMNY_NM FROM CTMMNY_INFO ci WHERE ci.CTMMNY_ID = p.CTMMNY_ID) AS CTMMNY_NM
            , DATE_FORMAT(CTRT_YMD, '%Y-%m-%d') AS CTRT_YMD
            , DATE_FORMAT(BIZ_END_YMD, '%Y-%m-%d') AS BIZ_END_YMD
            , DATE_FORMAT(STBLE_END_YMD, '%Y-%m-%d') AS STBLE_END_YMD
            , COUNT(*) OVER () AS TOTAL_ITEMS
        FROM PRJCT p
        WHERE 1 = 1
        <if test="prjctStleCd != null and !prjctStleCd.equals('')">
	      AND PRJCT_STLE_CD = #{prjctStleCd}
        </if>
        <if test="prjctId != null and !prjctId.equals('')">
	      AND PRJCT_ID = #{prjctId}
        </if>
        <if test="bizFlfmtTyCd != null and !bizFlfmtTyCd.equals('')">
	      AND BIZ_FLFMT_TY_CD = #{bizFlfmtTyCd}
        </if>
        <if test="ctrtYmd != null and bizEndYmd == null">
	      AND CTRT_YMD >= #{ctrtYmd}
        </if>
        <if test="ctrtYmd == null and bizEndYmd != null">
	      AND BIZ_END_YMD &lt;= #{bizEndYmd}
        </if>
        <if test="ctrtYmd != null and bizEndYmd != null">
        <if test="!ctrtYmd.equals('') and !bizEndYmd.equals('')">
	      AND CTRT_YMD BETWEEN #{ctrtYmd} AND #{bizEndYmd}
        </if>
	    </if>
	    <if test="prjctNm != null and !prjctNm.equals('')">
          AND PRJCT_NM = #{prjctNm}
		</if>
        <if test="ctmmnyNm != null and !ctmmnyNm.equals('')">
          AND CTMMNY_ID IN (SELECT CTMMNY_ID FROM CTMMNY_INFO WHERE CTMMNY_NM LIKE CONCAT('%',#{ctmmnyNm},'%'))
   	 	</if>	
		ORDER BY p.REG_DT DESC
	</select>

    <!--프로젝트청구현황개인별 수행인력-->
    <select id="retrievePrjctCtClmSttusIndvdlMMAccto" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            pma.EMP_ID,
            dept.DEPT_NM,
            e.EMP_FLNM,
            CONCAT(SUBSTR(#{startYmOdr},1, 6),'-',SUBSTR(#{startYmOdr}, 7, 1)) AS START_APLY_ODR,
            CONCAT(SUBSTR(#{endYmOdr},1, 6),'-',SUBSTR(#{endYmOdr}, 7, 1)) AS END_APLY_ODR,
            IFNULL(mmp.EXPECT_MM,0) AS EXPECT_MM,
            ROUND(SUM(CASE WHEN pmat.ATRZ_DMND_STTS_CD='VTW03703' THEN pma.MD ELSE 0 END/mm.COUNT),2) AS TOTAL_MD_SUM,
            ROUND((IFNULL(mmp.EXPECT_MM,0) - ROUND(SUM(CASE WHEN pmat.ATRZ_DMND_STTS_CD='VTW03703' THEN pma.MD ELSE 0 END/mm.COUNT),2)),2) AS USE_MM,
            SUM(pma.MD*8) AS CLM_MD
        FROM PRJCT_MM_APLY pma
        LEFT JOIN PRJCT_MM_ATRZ pmat ON pmat.PRJCT_ID = pma.PRJCT_ID AND (pmat.EMP_ID = pma.EMP_ID OR (pmat.EMP_ID IS NULL AND pma.EMP_ID IS NULL)) AND pmat.APLY_YM = pma.APLY_YM AND pmat.APLY_ODR = pma.APLY_ODR AND pmat.APLY_YMD = pma.APLY_YMD
        JOIN EMP e ON e.EMP_ID = pma.EMP_ID
        JOIN (
            SELECT DATE_FORMAT(CRTR_YMD, '%Y%m') AS YM,
            COUNT(*) AS COUNT
            FROM CRTR_DATE
            WHERE HLDY_CL_CD = 'VTW05001'
            GROUP BY DATE_FORMAT(CRTR_YMD, '%Y%m')
        ) AS mm ON (pma.APLY_YM = mm.YM)
        JOIN (
            SELECT GROUP_CONCAT(DISTINCT d.DEPT_NM) AS DEPT_NM, pma.EMP_ID
            FROM DEPT d
            JOIN DEPT_HNF dh ON (d.DEPT_ID = dh.DEPT_ID)
            JOIN PRJCT_MM_APLY pma ON (pma.EMP_ID = dh.EMP_ID)
            GROUP BY pma.EMP_ID
        ) dept ON dept.EMP_ID = e.EMP_ID
        JOIN (SELECT MAX(BGT_MNG_ODR) AS BGT_MNG_ODR FROM PRJCT_BGT_PRMPC pbp WHERE pbp.PRJCT_ID = #{prjctId} AND pbp.ATRZ_DMND_STTS_CD = 'VTW03703') odr
        LEFT JOIN (
            SELECT mlp.EMP_ID, SUM(mim.EXPECT_MM) AS EXPECT_MM, mlp.BGT_MNG_ODR
            FROM MMNY_LBRCO_PRMPC mlp
            JOIN MMNY_INPT_MM mim ON (mim.PRJCT_ID = mlp.PRJCT_ID AND mim.MMNY_LBRCO_PRMPC_SN = mlp.MMNY_LBRCO_PRMPC_SN AND mlp.BGT_MNG_ODR = mim.BGT_MNG_ODR)
            WHERE 1=1
            AND mim.PRJCT_ID = #{prjctId}
            AND mim.INPT_YM BETWEEN SUBSTR(#{startYmOdr},1, 6) AND SUBSTR(#{endYmOdr},1, 6)
            GROUP BY mlp.EMP_ID, mlp.BGT_MNG_ODR)
            mmp ON (mmp.EMP_ID = pma.EMP_ID AND mmp.BGT_MNG_ODR = odr.BGT_MNG_ODR)
        WHERE 1 = 1
        AND pmat.ATRZ_DMND_STTS_CD NOT IN ('VTW03701', 'VTW03708')
        <if test="prjctId != null and !prjctId.equals('')">
            AND pma.PRJCT_ID = #{prjctId}
        </if>
        <if test="empFlnm != null and !empFlnm.equals('')">
            AND e.EMP_FLNM = #{empFlnm}
        </if>
        <if test="(startYmOdr != null and !startYmOdr.equals('')) and (endYmOdr != null and !endYmOdr.equals(''))">
            AND CONCAT(pma.APLY_YM, pma.APLY_ODR) BETWEEN #{startYmOdr} AND #{endYmOdr}
        </if>
        <if test="empId != null and !empId.equals('')">
            AND pma.EMP_ID = #{empId}
        </if>
        GROUP BY pma.EMP_ID, mmp.EXPECT_MM
    </select>

    <!--프로젝트청구현황개인별 경비-->
    <select id="retrievePrjctCtClmSttusIndvdlCtAccto" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            (SELECT CD_NM FROM nwTr.CD cd WHERE UP_CD_VALUE = 'VTW045' AND CD_VALUE = pca.EXPENS_CD) AS EXPENS_NM,
            pca.EXPENS_CD,
            CONCAT(SUBSTR(#{startYmOdr},1, 6),'-',SUBSTR(#{startYmOdr}, 7, 1)) AS START_APLY_ODR,
            CONCAT(SUBSTR(#{endYmOdr},1, 6),'-',SUBSTR(#{endYmOdr}, 7, 1)) AS END_APLY_ODR,
            IFNULL((
                SELECT SUM(a.UTZTN_AMT)
                FROM PRJCT_CT_APLY a
                LEFT JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_ID = a.PRJCT_ID AND pcat.EMP_ID = a.EMP_ID
                AND pcat.APLY_YM = a.APLY_YM AND pcat.APLY_ODR = a.APLY_ODR AND pcat.PRJCT_CT_APLY_SN = a.PRJCT_CT_APLY_SN)
                WHERE a.EXPENS_CD = pca.EXPENS_CD
                AND a.PRJCT_ID = pca.PRJCT_ID
                AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
                GROUP BY a.EXPENS_CD
            ),0) AS TOTAL_AMT_SUM,
            SUM(pca.UTZTN_AMT) AS TOTAL_AMT
        FROM PRJCT_CT_APLY pca
        LEFT JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_ID = pca.PRJCT_ID AND (pcat.EMP_ID = pca.EMP_ID OR (pcat.EMP_ID IS NULL AND pca.EMP_ID IS NULL))
        AND pcat.APLY_YM = pca.APLY_YM AND pcat.APLY_ODR = pca.APLY_ODR AND pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN)
        WHERE 1 = 1
        AND pcat.ATRZ_DMND_STTS_CD NOT IN ('VTW03701', 'VTW03708')
        <if test="prjctId != null and !prjctId.equals('')">
            AND pca.PRJCT_ID = #{prjctId}
        </if>
        <if test="(startYmOdr != null and !startYmOdr.equals('')) and (endYmOdr != null and !endYmOdr.equals(''))">
            AND CONCAT(pca.APLY_YM, pca.APLY_ODR) BETWEEN #{startYmOdr} AND #{endYmOdr}
        </if>
        <if test="expensCd != null and !expensCd.equals('')">
            AND pca.EXPENS_CD = #{expensCd}
        </if>
        GROUP BY TOTAL_AMT_SUM, EXPENS_CD, START_APLY_ODR, END_APLY_ODR
    </select>

    <!-- 프로젝트청구현황개인별 수행인력 팝업 -->
    <select id="retrievePrjctCtClmSttusIndvdlMMAcctoDetail" parameterType="map" resultType="com.trsystem.LowerHashMap">
        WITH RECURSIVE VCATN_CNT AS (
            SELECT
                ATRZ.ELCTRN_ATRZ_ID
                ,EMP.EMP_ID
                ,DATE(ATRZ.VCATN_BGNG_YMD) AS VCATN_BGNG_YMD
                ,DATE(ATRZ.VCATN_END_YMD) AS VCATN_END_YMD
                ,ATRZ.VCATN_TY_CD
                ,(SELECT CD_NM FROM CD WHERE CD_VALUE = ATRZ.VCATN_TY_CD) AS VCATN_TY_NM
                ,CASE
                    WHEN ATRZ.VCATN_TY_CD IN ('VTW01201', 'VTW01204', 'VTW01207', 'VTW01208', 'VTW05301', 'VTW05302', 'VTW05303') THEN '8 hrs'
                ELSE '4 hrs'
                END VCATN_TIME
                ,ATRZ.VCATN_DE_CNT AS FLAG_CNT
                FROM VCATN_ATRZ 	ATRZ
                ,ELCTRN_ATRZ	ELCTRN
                ,EMP			EMP
            WHERE ATRZ.ELCTRN_ATRZ_ID = ELCTRN.ELCTRN_ATRZ_ID
                AND ELCTRN.ATRZ_DMND_EMP_ID = EMP.EMP_ID
                AND ATRZ.VCATN_TY_CD != 'VTW01206'
                AND ELCTRN.ATRZ_DMND_STTS_CD = 'VTW03703'
                AND ELCTRN.ATRZ_DMND_EMP_ID = #{empId}
                AND (SUBSTR(#{startYmOdr}, 1, 6) BETWEEN (SUBSTR(ATRZ.VCATN_BGNG_YMD, 1, 6)) AND SUBSTR(ATRZ.VCATN_END_YMD, 1, 6)
                    OR SUBSTR(#{endYmOdr}, 1, 6) BETWEEN (SUBSTR(ATRZ.VCATN_BGNG_YMD, 1, 6)) AND SUBSTR(ATRZ.VCATN_END_YMD, 1, 6))
            UNION ALL
            SELECT
                ELCTRN_ATRZ_ID
                ,EMP_ID
                ,DATE_ADD(VCATN_BGNG_YMD, INTERVAL 1 DAY) AS VCATN_BGNG_YMD
                ,VCATN_END_YMD
                ,VCATN_TY_CD
                ,VCATN_TY_NM
                ,VCATN_TIME
                ,FLAG_CNT - 1
            FROM VCATN_CNT
            WHERE VCATN_BGNG_YMD <![CDATA[<]]> VCATN_END_YMD
        )
        SELECT
            pma.MD*8 AS MD,
            CONCAT(pma.MD*8, 'hrs | ', e.EMP_FLNM, '(', c.CD_NM, ')') AS TEXT,
            c.CD_NM AS ATRZ_DMND_STTS_NM ,
            DATE_FORMAT(pma.APLY_YMD, '%Y-%m-%d') AS START_DATE,
            DATE_FORMAT(pma.APLY_YMD,'%Y-%m-%d') AS END_DATE,
            (SELECT EMP_FLNM FROM EMP WHERE EMP_ID = pah.APRVR_EMP_ID) AS APRVR_EMP_FLNM,
            dept.DEPT_NM
        FROM PRJCT_MM_APLY pma
        JOIN PRJCT_MM_ATRZ pah
            ON pma.PRJCT_ID = pah.PRJCT_ID
            AND pma.EMP_ID = pah.EMP_ID
            AND pma.APLY_YM = pah.APLY_YM
            AND pma.APLY_YMD = pah.APLY_YMD
            AND pma.APLY_ODR = pah.APLY_ODR
            AND pah.ATRZ_DMND_STTS_CD = 'VTW03703' -- 결재요청상태코드 : 승인
        JOIN EMP e
            ON pma.EMP_ID = e.EMP_ID
        JOIN CD c
            ON pah.ATRZ_DMND_STTS_CD = c.CD_VALUE
        JOIN (
            SELECT GROUP_CONCAT(DISTINCT d.DEPT_NM) AS DEPT_NM, pma.EMP_ID
            FROM DEPT d
            JOIN DEPT_HNF dh ON (d.DEPT_ID = dh.DEPT_ID)
            JOIN PRJCT_MM_APLY pma ON (pma.EMP_ID = dh.EMP_ID)
            GROUP BY pma.EMP_ID
        ) dept ON dept.EMP_ID = e.EMP_ID
        WHERE 1 = 1
        <if test="prjctId != null and !prjctId.equals('')">
            AND pma.PRJCT_ID = #{prjctId}
        </if>
        <if test="(startYmOdr != null and !startYmOdr.equals('')) and (endYmOdr != null and !endYmOdr.equals(''))">
            AND CONCAT(pma.APLY_YM, pma.APLY_ODR) BETWEEN #{startYmOdr} AND #{endYmOdr}
        </if>
        <if test="empId != null and !empId.equals('')">
            AND pma.EMP_ID = #{empId}
        </if>
        UNION ALL
        SELECT
            ''
            , CONCAT(VCATN_TIME, ' | ', VCATN_TY_NM) AS TEXT
            , ''
            , DATE_FORMAT(VCATN_BGNG_YMD, '%Y-%m-%d') AS START_DATE
            , DATE_FORMAT(VCATN_BGNG_YMD, '%Y-%m-%d') AS END_DATE
            , ''
            , ''
        FROM VCATN_CNT	CNT, CRTR_DATE	CRTR
        WHERE 1 = 1
        AND DATE_FORMAT(VCATN_BGNG_YMD, '%Y%m%d') = CRTR.CRTR_YMD
        AND CRTR.HLDY_CL_CD = 'VTW05001'
    </select>

    <!-- 프로젝트청구현황개인별 경비팝업 -->
    <select id="retrievePrjctCtClmSttusIndvdlCtAcctoDetail" parameterType="map" resultType="com.trsystem.LowerHashMap">
        WITH RECURSIVE DateRange AS (
            SELECT CONCAT(SUBSTR(#{startYmOdr}, 1, 4), '-', SUBSTR(#{startYmOdr}, 5, 2), '-01') AS APLY_YMD
            UNION ALL
            SELECT DATE_ADD(APLY_YMD, INTERVAL 1 DAY)
            FROM DateRange
            WHERE APLY_YMD &lt; LAST_DAY(CONCAT(SUBSTR(#{endYmOdr}, 1, 4), '-', SUBSTR(#{endYmOdr}, 5, 2), '-01'))
        ),
        Value AS (
            SELECT
                CONCAT(SUBSTR(b.UTZTN_DT, 1, 4),'-',SUBSTR(b.UTZTN_DT, 5, 2),'-',SUBSTR(b.UTZTN_DT, 7, 2)) AS APLY_YMD,
                (SELECT EMP_FLNM FROM nwTr.EMP emp WHERE EMP_ID = b.EMP_ID) AS EMP_FLNM,
                CONCAT('상세내역 : ', b.CT_PRPOS, ' | 용도 : ', b.ATDRN) AS EMP_DETAIL,
                (SELECT CD_NM FROM nwTr.CD cd WHERE UP_CD_VALUE = 'VTW045' AND CD_VALUE = b.EXPENS_CD) AS CD_NM,
                b.UTZTN_AMT
            FROM nwTr.PRJCT_INDVDL_CT_MM a, nwTr.PRJCT_CT_APLY b
            JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_ID = b.PRJCT_ID AND (pcat.EMP_ID = b.EMP_ID OR (pcat.EMP_ID IS NULL AND b.EMP_ID IS NULL))
                AND pcat.APLY_YM = b.APLY_YM AND pcat.APLY_ODR = b.APLY_ODR AND pcat.PRJCT_CT_APLY_SN = b.PRJCT_CT_APLY_SN AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703')
            WHERE 1 = 1
                AND a.PRJCT_ID = b.PRJCT_ID
                AND a.APLY_YM = b.APLY_YM
                AND a.APLY_ODR = b.APLY_ODR
                AND a.EMP_ID = b.EMP_ID
                AND a.CT_ATRZ_CMPTN_YN = 'Y'
                AND a.PRJCT_ID = #{prjctId}
                AND CONCAT(a.APLY_YM, a.APLY_ODR) BETWEEN #{startYmOdr} AND #{startYmOdr}
                AND b.EXPENS_CD = #{expensCd}
        )
        SELECT
            dt.APLY_YMD AS PIVOT_DATE
            , p.PRJCT_NM
            , v.EMP_FLNM
            , v.EMP_DETAIL
            , v.CD_NM
            , IFNULL(v2.UTZTN_AMT, 0) AS UTZTN_AMT
        FROM DateRange dt
        JOIN Value v
        LEFT JOIN Value v2 ON (v2.APLY_YMD = dt.APLY_YMD)
        JOIN PRJCT p ON p.PRJCT_ID = #{prjctId}
    </select>

    <!-- 프로젝트청구현황일자별 -직원추출 -->
    <select id="retrievePrjctCtClmgetEmp" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT DISTINCT(EMP_ID) AS EMP_ID
        FROM PRJCT_INDVDL_CT_MM
        WHERE PRJCT_ID = #{prjctId}
    </select>

    <!-- 프로젝트청구현황일자별 -->
    <select id="retrievePrjctCtClmYMDAccto" parameterType="map" resultType="com.trsystem.LowerHashMap">
        WITH RECURSIVE c AS (
        SELECT CAST(CONCAT(SUBSTR(#{startYmOdr}, 1, 6), '01') AS DATE) AS PIVOT_DATE
        UNION ALL
        SELECT DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY)
        FROM c
        WHERE DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY) <![CDATA[<=]]> IF(
        RIGHT(#{startYmOdr}, 1) = '1',
        DATE(CONCAT(SUBSTR(#{startYmOdr}, 1, 6), '15')),
        LAST_DAY(CAST(CONCAT(SUBSTR(#{endYmOdr}, 1, 6), '01') AS DATE))
        )
        )
        SELECT
             CONCAT(SUBSTR(PIVOT_DATE, 1, 4), '-', SUBSTR(PIVOT_DATE, 5, 2), '-', SUBSTR(PIVOT_DATE, 7, 2)) AS PIVOT_DATE
             , (SELECT PRJCT_NM FROM PRJCT P WHERE PRJCT_ID = #{prjctId}) AS PRJCT_NM
             , (SELECT EMP_FLNM FROM EMP EP WHERE EP.EMP_ID = #{empId}) AS  EMP_FLNM
             , EXPENS_CD
             , UTZTN_DT
             , IFNULL(SUM(UTZTN_AMT),0) AS UTZTN_AMT
             , IFNULL((MD * 8),0) AS MD
             , APLY_ODR
        FROM (SELECT DATE_FORMAT(PIVOT_DATE,'%Y%m%d') AS PIVOT_DATE
        FROM c
        WHERE PIVOT_DATE <![CDATA[<=]]> IF(
        RIGHT(#{startYmOdr}, 1) = '1',
        DATE(CONCAT(SUBSTR(#{startYmOdr}, 1, 6), '15')),
        LAST_DAY(CAST(CONCAT(SUBSTR(#{endYmOdr}, 1, 6), '01') AS DATE)))) T
        LEFT JOIN (
        SELECT P.PRJCT_NM,
        E.EMP_FLNM,
        (SELECT CD_NM FROM CD C WHERE C.CD_VALUE = PA.EXPENS_CD) AS EXPENS_CD,
        DATE_FORMAT(PA.UTZTN_DT, '%Y%m%d') AS UTZTN_DT,
        PA.UTZTN_AMT,
        PM.MD,
        PA.APLY_ODR
        FROM PRJCT_CT_APLY PA
        LEFT JOIN PRJCT P ON PA.PRJCT_ID = P.PRJCT_ID
        LEFT JOIN EMP E ON E.EMP_ID = PA.EMP_ID
        LEFT JOIN PRJCT_MM_APLY PM
        ON PA.PRJCT_ID = PM.PRJCT_ID
        AND DATE_FORMAT(PA.UTZTN_DT, '%Y%m%d') = PM.APLY_YMD
        AND PA.EMP_ID = PM.EMP_ID
        LEFT JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_ID = PA.PRJCT_ID AND (pcat.EMP_ID = PA.EMP_ID OR (pcat.EMP_ID IS NULL AND PA.EMP_ID IS NULL))
        AND pcat.APLY_YM = PA.APLY_YM AND pcat.APLY_ODR = PA.APLY_ODR AND pcat.PRJCT_CT_APLY_SN = PA.PRJCT_CT_APLY_SN) AND pcat.ATRZ_DMND_STTS_CD NOT IN ('VTW03701', 'VTW03708')
        WHERE P.PRJCT_ID = #{prjctId}
        <if test="empId != null and !empId.equals('')">
        AND E.EMP_ID = #{empId}
        </if>
        UNION ALL
        SELECT P.PRJCT_NM,
        E.EMP_FLNM,
        (SELECT CD_NM FROM CD C WHERE C.CD_VALUE = PA.EXPENS_CD) AS EXPENS_CD,
        DATE_FORMAT(PM.APLY_YMD, '%Y%m%d') AS APLY_YMD,
        NULL AS UTZTN_AMT,
        PM.MD,
        NULL AS APLY_ODR
        FROM PRJCT_MM_APLY PM
        LEFT JOIN PRJCT P ON PM.PRJCT_ID = P.PRJCT_ID
        LEFT JOIN EMP E ON E.EMP_ID = PM.EMP_ID
        LEFT JOIN PRJCT_CT_APLY PA
        ON PM.PRJCT_ID = PA.PRJCT_ID
        AND DATE_FORMAT(PM.APLY_YMD, '%Y%m%d') = DATE_FORMAT(PA.UTZTN_DT, '%Y%m%d')
        AND PM.EMP_ID = PA.EMP_ID
        LEFT JOIN PRJCT_MM_ATRZ pmat ON pmat.PRJCT_ID = PM.PRJCT_ID AND (pmat.EMP_ID = PM.EMP_ID OR (pmat.EMP_ID IS NULL AND PM.EMP_ID IS NULL))
        AND pmat.APLY_YM = PM.APLY_YM AND pmat.APLY_ODR = PM.APLY_ODR AND pmat.APLY_YMD = PM.APLY_YMD AND pmat.ATRZ_DMND_STTS_CD NOT IN ('VTW03701', 'VTW03708')
        WHERE PA.PRJCT_ID IS NULL
          AND P.PRJCT_ID = #{prjctId}
        <if test="empId != null and !empId.equals('')">
          AND E.EMP_ID = #{empId}
        </if>
        ) Z ON T.PIVOT_DATE = UTZTN_DT
        GROUP BY PIVOT_DATE, PRJCT_NM, EMP_FLNM, EXPENS_CD, UTZTN_DT, MD, APLY_ODR
    </select>

    <!-- 날짜 목록 -->
    <select id="retrieveDays" parameterType="map" resultType="com.trsystem.LowerHashMap">
    WITH RECURSIVE a AS (
        SELECT CAST(CONCAT(#{aplyYm}, '01') AS DATE) AS PIVOT_DATE
        UNION ALL
        SELECT DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY)
        FROM a
        WHERE DATE_ADD(PIVOT_DATE, INTERVAL 1 DAY) &lt; CAST(CONCAT(#{aplyYm}, '01') AS DATE) + INTERVAL 1 MONTH
    )
    SELECT *
    FROM a
    <if test="aplyOdr != null and !aplyOdr.equals('')">
        WHERE (
        #{aplyOdr} = 1 AND DAY(PIVOT_DATE) &lt;= 15
        ) OR (
        #{aplyOdr} = 2 AND DAY(PIVOT_DATE) > 15 AND DAY(PIVOT_DATE) &lt;= DAY(LAST_DAY(PIVOT_DATE)))
    </if>
    </select>

    <!-- 경비 승인내역 -->
    <select id="retrieveExpensAprvDtls" parameterType="map" resultType="com.trsystem.LowerHashMap">
            SELECT
            	pca.ELCTRN_ATRZ_ID AS unique_id, 
		    	CONCAT(p.PRJCT_NM, ' (PM : ', (SELECT EMP_FLNM FROM EMP WHERE EMP_ID = p.PRJCT_MNGR_EMP_ID), ')') AS PRJCT_NM, -- 프로젝트명
		    	(SELECT CD_NM FROM CD WHERE CD_VALUE = pca.EXPENS_CD) AS EXPENS_CD, -- 비용 코드
		    	e.EMP_FLNM as EMP_FLNM,
		    	CONCAT('성명 : ', e.EMP_FLNM, CHAR(10), ' | 상세내역 : ', pca.CT_PRPOS, ' | 용도 : ', pca.ATDRN) AS PRJCT_DETAIL,
		    	CONCAT('상세내역 : ', pca.CT_PRPOS, ' | 용도 : ', pca.ATDRN) AS EMP_DETAIL,
		    	pca.UTZTN_AMT as UTZTN_AMT,
		    	CONCAT(SUBSTR(pca.UTZTN_DT, 1, 4), '-', SUBSTR(pca.UTZTN_DT, 5, 2), '-', SUBSTR(pca.UTZTN_DT, 7, 2)) AS UTZTN_DT
			FROM
				 PRJCT_CT_APLY pca
			JOIN
				 PRJCT_CT_ATRZ pah
		    ON pca.PRJCT_CT_APLY_SN = pah.PRJCT_CT_APLY_SN
		    	AND pca.EMP_ID = pah.EMP_ID
		    	AND pca.PRJCT_ID = pah.PRJCT_ID
		    	AND pca.APLY_YM = pah.APLY_YM
		    	AND pca.APLY_ODR = pah.APLY_ODR
		    	AND pah.ATRZ_DMND_STTS_CD = 'VTW03703' -- 결재요청상태코드 : 승인
			JOIN
				EMP e ON pca.EMP_ID = e.EMP_ID		--
			JOIN 
				PRJCT p ON pca.PRJCT_ID = p.PRJCT_ID
			LEFT JOIN
				 ELCTRN_ATRZ ea ON pca.ELCTRN_ATRZ_ID = ea.ELCTRN_ATRZ_ID
			LEFT JOIN
				 CLM_ATRZ ca ON ea.ELCTRN_ATRZ_ID = ca.ELCTRN_ATRZ_ID
			LEFT JOIN
				 ELCTRN_ATRZ_DOC_FORM eadf ON ea.ATRZ_FORM_DOC_ID = eadf.ATRZ_FORM_DOC_ID
            WHERE 
            1 = 1
            <if test="prjctId != null and !prjctId.equals('')">
                AND pca.PRJCT_ID = #{prjctId}
            </if>
            <if test="aplyYm != null and !aplyYm.equals('')">
                AND pca.APLY_YM = #{aplyYm}
            </if>
            <if test="aplyOdr != null and !aplyOdr.equals('')">
                AND pca.APLY_ODR = #{aplyOdr}
            </if>
            <if test="empNo != null and !empNo.equals('')">
                AND e.EMPNO = #{empNo}
            </if>
            <if test="expensCd != null and !expensCd.equals('')">
                AND pca.EXPENS_CD = #{expensCd}
            </if>
    </select>

    <!--근무시간비용 입력현황 total조회-->
    <select id="retrieveTotWorkHrCtInptSttus" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            ALL_VTW,
            MM_03701,
            (ALL_VTW - MM_03701) AS MM_03701_MIN,
            MM_03702,
            (MM_03701 - MM_03702) AS MM_03702_MIN,
            MM_037034,
            (MM_03702 - MM_037034) AS MM_037034_MIN,
            CT_03701,
            (ALL_VTW - CT_03701) AS CT_03701_MIN,
            CT_03702,
            (CT_03701 - CT_03702) AS CT_03702_MIN,
            CT_037034,
            (CT_03702 - CT_037034) AS CT_037034_MIN,
            NULL AS EMP_ID
        FROM (
            SELECT COUNT(1) AS ALL_VTW
            FROM EMP e
            WHERE 1 = 1
            <if test="hdofSttsCd != null and !hdofSttsCd.equals('')">
                AND HDOF_STTS_CD = #{hdofSttsCd}
            </if>
            <if test="empId != null and !empId.equals('')">
                AND EMP_ID = #{empId}
            </if>
              AND EMP_TY_CD != 'VTW00203'
              AND e.EMPNO NOT IN ('VK0101', 'VK0102', 'VK0103', 'VK0104', 'VK0105', 'VK0106', 'VK0107', 'VK0108', 'VK0109', 'VK0110', 'VM1000')
        ) a, (
            SELECT
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('','VTW03701','VTW03702','VTW03703','VTW03704') THEN pma.EMP_ID END) AS MM_03701,
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03702','VTW03703','VTW03704') THEN pma.EMP_ID END) AS MM_03702,
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03703','VTW03704') THEN pma.EMP_ID END) AS MM_037034
            FROM PRJCT_MM_APLY pma
            JOIN PRJCT_MM_ATRZ pah
                ON pma.PRJCT_ID = pah.PRJCT_ID
                AND pma.EMP_ID = pah.EMP_ID
                AND pma.APLY_YM = pah.APLY_YM
                AND pma.APLY_ODR = pah.APLY_ODR
            WHERE 1 = 1
            <if test="aplyYm != null and !aplyYm.equals('')">
                AND pma.APLY_YM = #{aplyYm}
            </if>
            <if test="aplyOdr != null and !aplyOdr.equals('')">
                AND pma.APLY_ODR = #{aplyOdr}
            </if>
            <if test="hdofSttsCd != null and !hdofSttsCd.equals('')">
                AND pma.EMP_ID IN (SELECT EMP_ID FROM EMP WHERE HDOF_STTS_CD = #{hdofSttsCd})
            </if>
            <if test="empId != null and !empId.equals('')">
                AND pma.EMP_ID = #{empId}
            </if>
        ) b, (
            SELECT
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('','VTW03701','VTW03702','VTW03703','VTW03704') THEN pca.EMP_ID END) AS CT_03701,
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03702','VTW03703','VTW03704') THEN pca.EMP_ID END) AS CT_03702,
                COUNT(DISTINCT CASE WHEN pah.ATRZ_DMND_STTS_CD IN ('VTW03703','VTW03704') THEN pca.EMP_ID END) AS CT_037034
            FROM PRJCT_CT_APLY pca
            JOIN PRJCT_CT_ATRZ pah
                ON pca.PRJCT_ID = pah.PRJCT_ID
                AND pca.EMP_ID = pah.EMP_ID
                AND pca.APLY_YM = pah.APLY_YM
                AND pca.APLY_ODR = pah.APLY_ODR
            	AND pca.PRJCT_CT_APLY_SN = pah.PRJCT_CT_APLY_SN
            WHERE 1 = 1
		      AND (pca.CT_STLM_SE_CD = 'VTW01902' OR pca.CT_STLM_SE_CD = 'VTW01903')
            <if test="aplyYm != null and !aplyYm.equals('')">
                AND pca.APLY_YM = #{aplyYm}
            </if>
            <if test="aplyOdr != null and !aplyOdr.equals('')">
                AND pca.APLY_ODR = #{aplyOdr}
            </if>
            <if test="hdofSttsCd != null and !hdofSttsCd.equals('')">
                AND pca.EMP_ID IN (SELECT EMP_ID FROM EMP WHERE HDOF_STTS_CD = #{hdofSttsCd})
            </if>
            <if test="empId != null and !empId.equals('')">
                AND pca.EMP_ID = #{empId}
            </if>
        ) c
    </select>

    <!--근무시간비용 입력현황 세부 조회-->
    <select id="retrieveWorkHrCtInptSttus" parameterType="map" resultType="com.trsystem.LowerHashMap">
	     SELECT
	     	    AA.EMPNO
	          , AA.EMP_ID
	          , AA.EMP_FLNM
	          , (SELECT CD_NM FROM CD WHERE CD_VALUE = AA.JBPS_CD) AS JBPS_NM
	          , AA.JBPS_CD
	          , (
	              SELECT DEPT_NM
	              FROM DEPT d
	              WHERE DEPT_ID = (SELECT dh.DEPT_ID FROM DEPT_HNF dh WHERE dh.EMP_ID = AA.EMP_ID LIMIT 1)
	                AND d.END_YN = 'N'
	          ) AS DEPT_NM
	          , (
		         SELECT GROUP_CONCAT(DISTINCT DEPT_NM) DEPT_NM_ALL
		         FROM DEPT d
		         JOIN DEPT_HNF dh ON d.DEPT_ID = dh.DEPT_ID
		         JOIN EMP e ON dh.EMP_ID = e.EMP_ID 
		         WHERE e.EMP_ID = AA.EMP_ID
		           AND d.END_YN = 'N'
	          ) AS DEPT_NM_ALL
	          , AA.TELNO
	          , (SELECT CD_NM FROM CD WHERE CD_VALUE = AA.HDOF_STTS_CD) AS HDOF_STTS_NM
	          , IFNULL(BB.CT_CNT, 0) AS CT_CNT
	          , IFNULL(BB.PRJ_REQUEST, 0) AS PRJ_REQUEST
	          , IFNULL(BB.PRJ_REJECT, 0) AS CT_REJECT
	          , IFNULL(BB.PRJ_COMPLETE, 0) AS CT_COMPLETE
	          , IFNULL(CC.MD_SUM,0) * 8 AS MD_SUM
	          , IFNULL(CC.VAC_SUM, 0) AS VAC_SUM
              , IFNULL(CC.MM_REQUEST, 0) AS MM_REQUEST
              , IFNULL(CC.MM_APRV, 0) AS MM_APRV
              , IFNULL(CC.MM_APRV, 0) + IFNULL(CC.VAC_SUM, 0) + IFNULL(CC.MM_REJECT, 0) AS MM_COMPLETE
	          , CONCAT(CC.APLY_YM, '-', CC.APLY_ODR) AS TR_ODR
	          , CC.APLY_YM
	          , CC.APLY_ODR
	      FROM EMP AA
	      LEFT JOIN (
				  SELECT T1.EMP_ID
				       , T1.APLY_YM
				       , T1.APLY_ODR
				 	   , IFNULL(T1.CT_CNT, 0) AS CT_CNT
				   	   , IFNULL(T2.PRJ_COMPLETE, 0) AS PRJ_COMPLETE
				 	   , IFNULL(T3.PRJ_REJECT, 0) AS PRJ_REJECT
				 	   , IFNULL(T4.PRJ_REQUEST, 0) AS PRJ_REQUEST
			  		FROM (
				  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , COUNT(1) CT_CNT
				    FROM PRJCT_CT_APLY pca
				    JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
 				     AND pcat.ATRZ_DMND_STTS_CD IN ('VTW03701','VTW03702','VTW03703','VTW03704')
 				     AND (pca.CT_STLM_SE_CD = 'VTW01902' OR pca.CT_STLM_SE_CD = 'VTW01903')
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR
			  ) T1
		  LEFT JOIN (
				  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , COUNT(1) AS PRJ_COMPLETE
				    FROM PRJCT_CT_APLY pca
				    JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
				     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
				     AND (pca.CT_STLM_SE_CD = 'VTW01902' OR pca.CT_STLM_SE_CD = 'VTW01903')
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR
			  ) T2 ON (T1.EMP_ID = T2.EMP_ID)
		  LEFT JOIN (
				  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , COUNT(1) AS PRJ_REJECT
				    FROM PRJCT_CT_APLY pca
				    JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
				     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03704'
				     AND (pca.CT_STLM_SE_CD = 'VTW01902' OR pca.CT_STLM_SE_CD = 'VTW01903')
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR
			  ) T3 ON (T1.EMP_ID = T3.EMP_ID)
		  LEFT JOIN (
				  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , COUNT(1) AS PRJ_REQUEST
				    FROM PRJCT_CT_APLY pca
				    JOIN PRJCT_CT_ATRZ pcat ON (pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
				     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03702'
				     AND (pca.CT_STLM_SE_CD = 'VTW01902' OR pca.CT_STLM_SE_CD = 'VTW01903')
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR
			  ) T4 ON (T1.EMP_ID = T4.EMP_ID)
	    ) BB ON BB.EMP_ID = AA.EMP_ID
	    LEFT OUTER JOIN (
	        SELECT T1.EMP_ID
	         	 , T1.APLY_YM
	         	 , T1.APLY_ODR
	         	 , IFNULL(SUM(T1.MM_CNT), 0) AS MD_SUM
	         	 , IFNULL(SUM(T2.MM_APRV), 0) * 8 AS MM_APRV
	         	 , IFNULL(SUM(T3.MM_REJECT), 0) * 8 AS MM_REJECT
	         	 , IFNULL(SUM(T4.MM_REQUEST), 0) * 8 AS MM_REQUEST
	         	 , IFNULL(SUM(T2.VAC), 0) * 8 AS VAC_SUM
	        FROM (
				SELECT pca.EMP_ID
				     , pca.APLY_YM 
				     , pca.APLY_ODR 
				     , SUM(MD) MM_CNT
				     , pca.APLY_YMD
				     , 0 AS VAC
			      FROM PRJCT_MM_APLY pca
			      JOIN PRJCT_MM_ATRZ pcat ON (pcat.APLY_YMD = pca.APLY_YMD AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
			     WHERE 1=1
			       AND pca.APLY_YM = #{aplyYm}
			       AND pca.APLY_ODR = #{aplyOdr}
			    GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, pca.APLY_YMD
			    UNION
			  SELECT dv.ATRZ_DMND_EMP_ID
			       , dv.APLY_YM
			       , dv.APLY_ODR
			       , 0 AS MM_CNT
			       , dv.APLY_YMD
			       , dv.VCATN_DE_CNT AS VAC
			    FROM (
					  WITH RECURSIVE DAILY_VACATION AS (SELECT
					          ELC.ELCTRN_ATRZ_ID ,
					          ELC.ATRZ_DMND_STTS_CD,
					          VAC.VCATN_TY_CD,
					          DATE(VAC.VCATN_BGNG_YMD) as dt,
					          DATE(VAC.VCATN_END_YMD) as end_dt,
					          ELC.ATRZ_DMND_EMP_ID,
					          ELC.PRJCT_ID,
					          VAC.VCATN_DE_CNT
					     FROM ELCTRN_ATRZ ELC
					     JOIN VCATN_ATRZ VAC 
					       ON ELC.ELCTRN_ATRZ_ID = VAC.ELCTRN_ATRZ_ID
					    WHERE 1=1
					      AND ELC.ATRZ_DMND_STTS_CD = 'VTW03703'
					      AND VAC.VCATN_TY_CD != 'VTW01207'
					    UNION ALL
					   SELECT
					          dr.ELCTRN_ATRZ_ID ,
					          dr.ATRZ_DMND_STTS_CD,
					          dr.VCATN_TY_CD,
					          DATE_ADD(dr.dt, INTERVAL 1 DAY) as dt,
					          dr.end_dt,
					          dr.ATRZ_DMND_EMP_ID,
					          dr.PRJCT_ID,
					          dr.VCATN_DE_CNT
					    FROM DAILY_VACATION dr
					    <![CDATA[ 
					   WHERE dr.dt < dr.end_dt)
					    ]]>
					  SELECT ELCTRN_ATRZ_ID
						   , ATRZ_DMND_STTS_CD
						   , VCATN_TY_CD
						   , dt
						   , DATE_FORMAT(dt, '%Y%m%d') AS APLY_YMD
						   , SUBSTR(DATE_FORMAT(dt, '%Y%m%d'), 1, 6) AS APLY_YM
						   , CASE 
						 	 WHEN SUBSTR(DATE_FORMAT(dt, '%Y%m%d'), 7, 8) BETWEEN '01' AND '15' THEN '1'
						 	 ELSE '2'
						 END AS APLY_ODR
						   , ATRZ_DMND_EMP_ID
						   , PRJCT_ID
						   , VCATN_DE_CNT
					   FROM DAILY_VACATION
				) dv
			 JOIN CRTR_DATE crd ON crd.CRTR_YMD = dv.APLY_YMD AND crd.HLDY_CL_CD = 'VTW05001'
			WHERE 1=1
			  AND dv.APLY_YM = #{aplyYm}
			  AND dv.APLY_ODR = #{aplyOdr}
			  AND dv.ATRZ_DMND_STTS_CD = 'VTW03703'
	        ) T1 
	        LEFT JOIN (
			  SELECT pca.EMP_ID
				   , pca.APLY_YM 
				   , pca.APLY_ODR 
				   , SUM(MD) AS MM_APRV
				   , pca.APLY_YMD
				   , 0 AS VAC
			    FROM PRJCT_MM_APLY pca
			    JOIN PRJCT_MM_ATRZ pcat ON (pcat.APLY_YMD = pca.APLY_YMD AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
			   WHERE 1=1
			     AND pca.APLY_YM = #{aplyYm}
			     AND pca.APLY_ODR = #{aplyOdr}
			     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
			  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, pca.APLY_YMD
			  UNION
			  SELECT dv.ATRZ_DMND_EMP_ID
			       , dv.APLY_YM
			       , dv.APLY_ODR
			       , 0 AS MM_APRV
			       , dv.APLY_YMD
			       , dv.VCATN_DE_CNT AS VAC
			    FROM (
					  WITH RECURSIVE DAILY_VACATION AS (SELECT
					          ELC.ELCTRN_ATRZ_ID ,
					          ELC.ATRZ_DMND_STTS_CD,
					          VAC.VCATN_TY_CD,
					          DATE(VAC.VCATN_BGNG_YMD) as dt,
					          DATE(VAC.VCATN_END_YMD) as end_dt,
					          ELC.ATRZ_DMND_EMP_ID,
					          ELC.PRJCT_ID,
					          VAC.VCATN_DE_CNT
					     FROM ELCTRN_ATRZ ELC
					     JOIN VCATN_ATRZ VAC 
					       ON ELC.ELCTRN_ATRZ_ID = VAC.ELCTRN_ATRZ_ID
					    WHERE 1=1
					      AND ELC.ATRZ_DMND_STTS_CD = 'VTW03703'
					      AND VAC.VCATN_TY_CD != 'VTW01207'
					    UNION ALL
					   SELECT
					          dr.ELCTRN_ATRZ_ID ,
					          dr.ATRZ_DMND_STTS_CD,
					          dr.VCATN_TY_CD,
					          DATE_ADD(dr.dt, INTERVAL 1 DAY) as dt,
					          dr.end_dt,
					          dr.ATRZ_DMND_EMP_ID,
					          dr.PRJCT_ID,
					          dr.VCATN_DE_CNT
					    FROM DAILY_VACATION dr
					    <![CDATA[ 
					   WHERE dr.dt < dr.end_dt)
					    ]]>
					  SELECT ELCTRN_ATRZ_ID
						   , ATRZ_DMND_STTS_CD
						   , VCATN_TY_CD
						   , dt
						   , DATE_FORMAT(dt, '%Y%m%d') AS APLY_YMD
						   , SUBSTR(DATE_FORMAT(dt, '%Y%m%d'), 1, 6) AS APLY_YM
						   , CASE 
						 	 WHEN SUBSTR(DATE_FORMAT(dt, '%Y%m%d'), 7, 8) BETWEEN '01' AND '15' THEN '1'
						 	 ELSE '2'
						 END AS APLY_ODR
						   , ATRZ_DMND_EMP_ID
						   , PRJCT_ID
						   , VCATN_DE_CNT
					   FROM DAILY_VACATION
				) dv
			 JOIN CRTR_DATE crd ON crd.CRTR_YMD = dv.APLY_YMD AND crd.HLDY_CL_CD = 'VTW05001'
			WHERE 1=1
			  AND dv.APLY_YM = #{aplyYm}
			  AND dv.APLY_ODR = #{aplyOdr}
			  AND dv.ATRZ_DMND_STTS_CD = 'VTW03703'
	        ) T2 ON (T1.EMP_ID = T2.EMP_ID AND T1.APLY_YMD = T2.APLY_YMD AND T1.MM_CNT = T2.MM_APRV)
	        LEFT JOIN (
	 			  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , SUM(MD) AS MM_REJECT
					   , pca.APLY_YMD
	   			       , 0 AS VAC
				    FROM PRJCT_MM_APLY pca
				    JOIN PRJCT_MM_ATRZ pcat ON (pcat.APLY_YMD = pca.APLY_YMD AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
				     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03704'
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, pca.APLY_YMD      
	        ) T3 ON (T1.EMP_ID = T3.EMP_ID AND T1.APLY_YMD = T3.APLY_YMD AND T1.MM_CNT = T3.MM_REJECT)
	        LEFT JOIN (
	 			  SELECT pca.EMP_ID
					   , pca.APLY_YM 
					   , pca.APLY_ODR 
					   , SUM(MD) AS MM_REQUEST
					   , pca.APLY_YMD
	   			       , 0 AS VAC
				    FROM PRJCT_MM_APLY pca
				    JOIN PRJCT_MM_ATRZ pcat ON (pcat.APLY_YMD = pca.APLY_YMD AND pca.PRJCT_ID = pcat.PRJCT_ID AND pca.EMP_ID = pcat.EMP_ID AND pca.APLY_YM = pcat.APLY_YM)
				   WHERE 1=1
				     AND pca.APLY_YM = #{aplyYm}
				     AND pca.APLY_ODR = #{aplyOdr}
				     AND pcat.ATRZ_DMND_STTS_CD = 'VTW03702'
				  GROUP BY pca.EMP_ID, pca.APLY_YM, pca.APLY_ODR, pca.APLY_YMD      
	        ) T4 ON (T1.EMP_ID = T4.EMP_ID AND T1.APLY_YMD = T4.APLY_YMD AND T1.MM_CNT = T4.MM_REQUEST)
	        GROUP BY T1.EMP_ID, T1.APLY_YM, T1.APLY_ODR
	    ) CC
	        ON CC.EMP_ID = AA.EMP_ID
	    WHERE 1 = 1
          AND AA.EMP_TY_CD != 'VTW00203'
        <if test="hdofSttsCd != null and !hdofSttsCd.equals('')">
            AND AA.HDOF_STTS_CD = #{hdofSttsCd}
        </if>
          AND AA.EMPNO NOT IN ('VK0101', 'VK0102', 'VK0103', 'VK0104', 'VK0105', 'VK0106', 'VK0107', 'VK0108', 'VK0109', 'VK0110', 'VM1000')
        <if test="empId != null and empId !=''">
            AND AA.EMP_ID = #{empId}
        </if>
		<if test="allVtw != true">
	        <choose>
				<when test="mm03701 == true and mm03701Min == true">
				<![CDATA[ 
				  AND (MD_SUM > 0 OR IFNULL(MD_SUM, 0) = 0)
				]]>
				</when>
				<when test="mm03701 == true">
				<![CDATA[ 
				  AND MD_SUM > 0
				]]>
				</when>
				<when test="mm03701Min == true">
				<![CDATA[ 
				  AND IFNULL(MD_SUM, 0) = 0
				]]>
				</when>
			</choose>
	        <choose>
				<when test="ct03701 == true and ct03701Min == true">
				<![CDATA[ 
				  AND (CT_CNT > 0 OR IFNULL(CT_CNT, 0) = 0)
				]]>
				</when>
				<when test="ct03701 == true">
				<![CDATA[ 
				  AND CT_CNT > 0
				]]>
				</when>
				<when test="ct03701Min == true">
				<![CDATA[ 
				  AND IFNULL(CT_CNT, 0) = 0
				]]>
				</when>
			</choose>
	        <choose>
				<when test="mm03702 == true and mm03702Min == true">
				<![CDATA[
				  AND ((CC.MM_REQUEST > 0 OR CC.MM_REJECT > 0 OR CC.MM_APRV > 0) OR (CC.MD_SUM > 0 AND (CC.MM_REQUEST <= 0 AND CC.MM_REJECT <= 0 AND CC.MM_APRV <= 0)))
	  			]]>
				</when>
				<when test="mm03702 == true">
				<![CDATA[
				  AND (CC.MM_REQUEST > 0 OR CC.MM_REJECT > 0 OR CC.MM_APRV > 0)
				]]>
				</when>
				<when test="mm03702Min == true">
				<![CDATA[
				  AND (CC.MD_SUM > 0 AND (CC.MM_REQUEST <= 0 AND CC.MM_REJECT <= 0 AND CC.MM_APRV <= 0))
	  			]]>
				</when>
			</choose>
	        <choose>
				<when test="ct03702 == true and ct03702Min == true">
				<![CDATA[
  				  AND ((BB.PRJ_REQUEST > 0 OR BB.PRJ_REJECT > 0 OR BB.PRJ_COMPLETE > 0) OR (BB.CT_CNT > 0 AND (BB.PRJ_REQUEST <= 0 AND BB.PRJ_REJECT <= 0 AND BB.PRJ_COMPLETE <= 0)))
	  			]]>
				</when>
				<when test="ct03702 == true">
				<![CDATA[ 
				  AND (BB.PRJ_REQUEST > 0 OR BB.PRJ_REJECT > 0 OR BB.PRJ_COMPLETE > 0)
				]]>
				</when>
				<when test="ct03702Min == true">
				<![CDATA[
				  AND (BB.CT_CNT > 0 AND (BB.PRJ_REQUEST <= 0 AND BB.PRJ_REJECT <= 0 AND BB.PRJ_COMPLETE <= 0))
				]]>
				</when>
			</choose>
	        <choose>
				<when test="mm037034 == true and mm037034Min == true">
				<![CDATA[ 
				  AND (CC.MM_REJECT > 0 OR CC.MM_APRV > 0 OR CC.MM_REJECT <= 0 OR CC.MM_APRV <= 0)
				]]>
				</when>
				<when test="mm037034 == true">
				<![CDATA[ 
				  AND (CC.MM_REJECT > 0 OR CC.MM_APRV > 0)
	  			]]>
				</when>
				<when test="mm037034Min == true">
				<![CDATA[ 
				  AND (CC.MM_REJECT <= 0 AND CC.MM_APRV <=0)
	  			]]>
				</when>
			</choose>
	        <choose>
				<when test="ct037034 == true and ct037034Min == true">
				<![CDATA[ 
				  AND (BB.PRJ_REJECT > 0 OR BB.PRJ_COMPLETE > 0 OR BB.PRJ_REJECT <= 0 OR BB.PRJ_COMPLETE <= 0)
				]]>
				</when>
				<when test="ct037034 == true">
				<![CDATA[ 
				  AND (BB.PRJ_REJECT > 0 OR BB.PRJ_COMPLETE > 0)
	  			]]>
				</when>
				<when test="ct037034Min == true">
				<![CDATA[ 
				  AND (BB.PRJ_REJECT <= 0 AND BB.PRJ_COMPLETE <=0)
	  			]]>
				</when>
			</choose>			
		</if>
		ORDER BY AA.EMPNO
    </select>

    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->


    <!--근무시간 승인 내역 -->
    <select id="retrievePrjctMmAplyList" parameterType="map" resultType="com.trsystem.LowerHashMap">
       SELECT DISTINCT
		    Z.CRTR_YMD AS APLY_YMD,
		    M.PRJCT_ID AS PRJCT_ID,
		    M.PRJCT_NM AS PRJCT_NM,
		    M.EMP_FLNM AS EMP_FLNM,
		    IFNULL(T.MD, 0) AS MD
		FROM
		    (
		    SELECT 
            	DATE_FORMAT(cd.CRTR_YMD, '%Y-%m-%d') AS CRTR_YMD
        	FROM 
            	CRTR_DATE cd
        	WHERE 
	            DATE_FORMAT(cd.CRTR_YMD , '%Y') = #{yearItem} 
	        	AND DATE_FORMAT(cd.CRTR_YMD , '%m') = #{monthItem}
	        	AND cd.CRTR_ODR = #{aplyOdr}
		    ) Z
	JOIN (
	    SELECT DISTINCT
	        P.PRJCT_ID,
	        P.PRJCT_NM,
	        E.EMP_FLNM
	    FROM 
	        PRJCT P
	        JOIN PRJCT_MM_APLY PMA ON P.PRJCT_ID = PMA.PRJCT_ID
	        JOIN PRJCT_INDVDL_CT_MM PICM ON PMA.PRJCT_ID = PICM.PRJCT_ID AND PMA.EMP_ID = PICM.EMP_ID AND PMA.APLY_YM = PICM.APLY_YM AND PMA.APLY_ODR = PICM.APLY_ODR
	        JOIN EMP E ON PMA.EMP_ID = E.EMP_ID
	    WHERE 
	        PICM.MM_ATRZ_CMPTN_YN = 'Y'
	        AND DATE_FORMAT(PMA.APLY_YMD , '%Y') = #{yearItem}
        	AND DATE_FORMAT(PMA.APLY_YMD , '%m') = #{monthItem}
        	AND PMA.APLY_ODR = #{aplyOdr}
	         <if test="prjctId != null and !prjctId.equals('')">
	        AND P.PRJCT_ID = #{prjctId}
	            </if>
		) M ON 1=1
		LEFT JOIN (
		    SELECT
		        P.PRJCT_ID AS PRJCT_ID,
		        DATE_FORMAT(PMA.APLY_YMD , '%Y-%m-%d') AS APLY_YMD,
		        P.PRJCT_NM AS PRJCT_NM,
		        E.EMP_FLNM AS EMP_FLNM,
		        PMA.MD*8 AS MD 
		    FROM 
		        PRJCT_MM_APLY PMA
		        JOIN PRJCT P ON P.PRJCT_ID = PMA.PRJCT_ID
		        JOIN PRJCT_INDVDL_CT_MM PICM ON PMA.PRJCT_ID = PICM.PRJCT_ID AND PMA.EMP_ID = PICM.EMP_ID AND PMA.APLY_YM = PICM.APLY_YM AND PMA.APLY_ODR = PICM.APLY_ODR
		        JOIN EMP E ON PMA.EMP_ID = E.EMP_ID
		    WHERE 
		        PICM.MM_ATRZ_CMPTN_YN = 'Y'
		           	AND DATE_FORMAT(PMA.APLY_YMD , '%Y') = #{yearItem} 
        			AND DATE_FORMAT(PMA.APLY_YMD , '%m') = #{monthItem}
		            AND PMA.APLY_ODR = #{aplyOdr}
		            <if test="prjctId != null and !prjctId.equals('')">
		            AND P.PRJCT_ID = #{prjctId}
		            </if>
		) T ON T.APLY_YMD = Z.CRTR_YMD AND M.PRJCT_ID = T.PRJCT_ID
		ORDER BY M.EMP_FLNM, APLY_YMD;
</select>


    <!--근무시간, 경비 통합승인 내역 -->
    <select id="retrieveWorkHrAprvList" parameterType="map" resultType="com.trsystem.LowerHashMap">
	SELECT
	    COALESCE(WORK_HOUR.W_EMP_ID, CT_LIST.C_EMP_ID) AS EMP_ID,                      -- 사원 ID
	    COALESCE(WORK_HOUR.W_EMP_FLNM, CT_LIST.EMP_FLNM) AS EMP_FLNM,                    -- 사원명
	    COALESCE(WORK_HOUR.PRJCT_NM, CT_LIST.PRJCT_NM) AS PRJCT_NM,                    -- 프로젝트명
	    WORK_HOUR.PRJCT_NON_INSERT AS PRJCT_NON_INSERT,                     -- 프로젝트 미투입 근무시간
	    WORK_HOUR.PRJCT_INSERT AS PRJCT_INSERT,                             -- 프로젝트 투입 근무시간
	    WORK_HOUR.VACATION AS VACATION,                                     -- 휴가 사용 내역
	    WORK_HOUR.TOTAL_PRJCT_NON_INSERT AS TOTAL_PRJCT_NON_INSERT,         -- 프로젝트 미투입 총 근무시간
	    WORK_HOUR.TOTAL_PRJCT_INSERT AS TOTAL_PRJCT_INSERT,                 -- 프로젝트 투입 총 근무시간
	    COALESCE(CT_LIST.PRJCT_NON_INSERT_EXPENSE,0)AS PRJCT_NON_INSERT_EXPENSE,       -- 프로젝트 미투입 비용
	    COALESCE(CT_LIST.PRJCT_INSERT_EXPENSE,0) AS PRJCT_INSERT_EXPENSE               -- 프로젝트 투입 비용
	FROM
    	(
	        SELECT
            E.EMP_ID AS W_EMP_ID,
            E.EMP_FLNM AS W_EMP_FLNM,
            P.PRJCT_NM AS PRJCT_NM,
            P.PRJCT_ID AS W_PRJCT_ID,
            E.EMPNO AS W_EMPNO,
            E.EMP_TY_CD AS W_EMP_TY_CD,
            SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01803' THEN PMA.MD*8 ELSE 0 END) AS PRJCT_NON_INSERT,
            SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01802' THEN PMA.MD*8 ELSE 0 END) AS PRJCT_INSERT,
            SUM(PMA.YRYC_RATE*8) AS VACATION,
            (SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01803' THEN PMA.MD*8 ELSE 0 END) +
             SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01803' THEN YRYC_RATE*8 ELSE 0 END)) AS TOTAL_PRJCT_NON_INSERT,
            (SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01802' THEN PMA.MD*8 ELSE 0 END) +
             SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01802' THEN YRYC_RATE*8 ELSE 0 END)) AS TOTAL_PRJCT_INSERT
        FROM
            PRJCT_INDVDL_CT_MM PICM,
            PRJCT_MM_APLY PMA,
            PRJCT P,
            EMP E
        WHERE
            PICM.PRJCT_ID = PMA.PRJCT_ID
          AND PICM.EMP_ID = PMA.EMP_ID
          AND PICM.APLY_YM = PMA.APLY_YM
          AND PICM.APLY_ODR = PMA.APLY_ODR
          AND P.PRJCT_ID = PICM.PRJCT_ID
          AND PMA.EMP_ID = E.EMP_ID
          AND PICM.MM_ATRZ_CMPTN_YN = 'Y'
          <if test="aplyYm != null and !aplyYm.equals('')">
           AND PMA.APLY_YM = #{aplyYm}
	      </if>
	      <if test="aplyOdr != null and !aplyOdr.equals('')">
	       AND PMA.APLY_ODR = #{aplyOdr}
	      </if>
        GROUP BY
            E.EMP_ID,
            P.PRJCT_ID
	   ) WORK_HOUR
	   LEFT JOIN
	    (
	        SELECT
	            E.EMP_ID AS C_EMP_ID,
	            E.EMP_FLNM AS EMP_FLNM,             -- 사원명 추가
	            P.PRJCT_ID AS C_PRJCT_ID,
	            P.PRJCT_NM AS PRJCT_NM,
	            SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01803' THEN PCA.UTZTN_AMT ELSE 0 END) AS PRJCT_NON_INSERT_EXPENSE,
	            SUM(CASE WHEN P.PRJCT_STLE_CD = 'VTW01802' THEN PCA.UTZTN_AMT ELSE 0 END) AS PRJCT_INSERT_EXPENSE
	        FROM
	            PRJCT_INDVDL_CT_MM PICM,
	            PRJCT P,
	            EMP E,
	            PRJCT_CT_APLY PCA
	        WHERE
	            E.EMP_ID = PICM.EMP_ID
	          AND PICM.PRJCT_ID = P.PRJCT_ID
	          AND PICM.PRJCT_ID = PCA.PRJCT_ID
	          AND PICM.EMP_ID = PCA.EMP_ID
	          AND PICM.APLY_YM = PCA.APLY_YM
	          AND PICM.APLY_ODR = PCA.APLY_ODR
	          AND PICM.CT_ATRZ_CMPTN_YN = 'Y'
	          <if test="aplyYm != null and !aplyYm.equals('')">
           	  AND PCA.APLY_YM = #{aplyYm}
	          </if>
	          <if test="aplyOdr != null and !aplyOdr.equals('')">
	          AND PCA.APLY_ODR = #{aplyOdr}
	          </if>
	         
	        GROUP BY
	            E.EMP_ID,
	            E.EMP_FLNM,
	            P.PRJCT_NM,
	            P.PRJCT_ID
	    ) CT_LIST
	ON WORK_HOUR.W_EMP_ID = CT_LIST.C_EMP_ID AND WORK_HOUR.W_PRJCT_ID = CT_LIST.C_PRJCT_ID
	WHERE 
		1=1
	<if test="prjctId != null and prjctId !=''">
        AND   W_PRJCT_ID = #{prjctId}
    </if>
    <if test="empFlnm != null and empFlnm !=''">
        AND   EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%')
    </if>
    <if test="empno != null and empno !=''">
         AND   W_EMPNO LIKE CONCAT('%', #{empno}, '%')
    </if>
    <if test="hdofSttsNm != null and hdofSttsNm !=''">
         AND   W_EMP_TY_CD LIKE CONCAT('%', #{hdofSttsNm}, '%')
    </if>
	ORDER BY EMP_ID, PRJCT_NM;


    </select>

    <!-- 문체비 마감 내역 -->
    <select id="retrieveClturPhstrnDdlnList" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            e.EMP_ID
            ,c.CD_NM AS BANK_NAME
            ,e.ACTNO
            ,e.EMP_FLNM
            ,cpac.DPST_AMT
            ,CONCAT(SUBSTR(CLTUR_PHSTRN_ACT_MNG_YM,5), '월 문화체련비' ) AS REMARK
        FROM CLTUR_PHSTRN_ACT_CT cpac
        JOIN EMP e ON e.EMP_ID = cpac.EMP_ID
        JOIN CD  c ON c.CD_VALUE  = e.BANK_CD
        WHERE 1=1
          AND cpac.CLTUR_PHSTRN_ACT_MNG_YM = #{clturPhstrnActMngYm}
          AND (#{empFlnm} IS NULL OR e.EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%'))
          AND (#{empno} IS NULL OR e.EMPNO LIKE CONCAT('%', #{empno}, '%'))
          AND cpac.DPST_AMT IS NOT NULL
          AND cpac.DPST_AMT > 0
    </select>

    <!-- 문체비 개인 현황 팝업 -->
    <select id="retrieveClturPhstrnIndvdlList" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
             EMP_ID
             ,CLTUR_PHSTRN_ACT_MNG_YM
             ,CLM_AMT
             ,DPST_AMT
             ,CYFD_AMT + CLM_AMT - DPST_AMT AS BALANCE
        FROM CLTUR_PHSTRN_ACT_CT
        WHERE 1=1
            AND CLTUR_PHSTRN_ACT_MNG_YM LIKE CONCAT(#{year}, '%')
            AND EMP_ID = #{empId}
    </select>

    <!-- 문체비 상세청구내역 팝업 -->
    <select id="retrieveClturPhstrnDetailList" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            c.EMP_ID
            , c.CLTUR_PHSTRN_ACT_CT_SN
            , c.CLM_AMT
            , c.CLTUR_PHSTRN_SE_CD
            , c.ACT_IEM
            , c.RM
            , c.ATCHMNFL_ID
            , a.ATCHMNFL_SN
            , a.REAL_FILE_NM
            , a.STRG_FILE_NM
        FROM CLTUR_PHSTRN_ACT_CT_REG c
                 LEFT JOIN  ATCHMNFL a ON c.ATCHMNFL_ID = a.ATCHMNFL_ID
        WHERE 1=1
          AND CLM_YMD LIKE CONCAT(#{ym}, '%')
          AND EMP_ID = #{empId}
          AND CLTUR_PHSTRN_SE_CD = #{clturPhstrnSeCd}
    </select>

    <!-- 문체비 지급 계산: 당월 입금금액 -->
    <update id="updateDpstAmtThisMonth" parameterType="map">
        UPDATE CLTUR_PHSTRN_ACT_CT AS c
        JOIN EMP AS e ON c.EMP_ID = e.EMP_ID
        SET
            c.FTNESS_TRNG_CT_DPST_AMT =
            CASE
                WHEN c.FTNESS_TRNG_CT_CYFD_AMT + c.FTNESS_TRNG_CT_CLM_AMT >= 200000 THEN 200000
                ELSE c.FTNESS_TRNG_CT_CYFD_AMT + c.FTNESS_TRNG_CT_CLM_AMT
            END,
            c.CLTUR_CT_DPST_AMT =
            CASE
                WHEN 200000 > c.FTNESS_TRNG_CT_CLM_AMT + c.FTNESS_TRNG_CT_CYFD_AMT
                THEN LEAST(200000 - (c.FTNESS_TRNG_CT_CLM_AMT + c.FTNESS_TRNG_CT_CYFD_AMT), c.CLTUR_CT_CYFD_AMT + c.CLTUR_CT_CLM_AMT)
                ELSE 0
            END,
            DPST_AMT =
                (CASE WHEN c.FTNESS_TRNG_CT_CYFD_AMT + c.FTNESS_TRNG_CT_CLM_AMT >= 200000 THEN 200000 ELSE c.FTNESS_TRNG_CT_CYFD_AMT + c.FTNESS_TRNG_CT_CLM_AMT END) +
                (CASE WHEN 200000 > c.FTNESS_TRNG_CT_CLM_AMT + c.FTNESS_TRNG_CT_CYFD_AMT THEN LEAST(200000 - (c.FTNESS_TRNG_CT_CLM_AMT + c.FTNESS_TRNG_CT_CYFD_AMT), c.CLTUR_CT_CYFD_AMT + c.CLTUR_CT_CLM_AMT) ELSE 0 END),
            c.FTNESS_TRNG_CT_DPST_YMD = CONCAT(#{nextMonth}, '15'),
            c.CLTUR_CT_DPST_YMD = CONCAT(#{nextMonth}, '15')
        WHERE c.CLTUR_PHSTRN_ACT_MNG_YM = #{clturPhstrnActMngYm}
        AND e.HDOF_STTS_CD = 'VTW00301'
        AND e.EMP_TY_CD = 'VTW00201'
    </update>

    <!-- 문체비 지급 계산: 익월 이월금액 -->
    <update id="updateDpstAmtNextMonth" parameterType="map">
        UPDATE CLTUR_PHSTRN_ACT_CT AS c1
        JOIN (
            SELECT
            EMP_ID,
            FTNESS_TRNG_CT_CYFD_AMT + FTNESS_TRNG_CT_CLM_AMT - FTNESS_TRNG_CT_DPST_AMT AS FTNESS,
            CLTUR_CT_CYFD_AMT + CLTUR_CT_CLM_AMT - CLTUR_CT_DPST_AMT AS CLTUR,
            CYFD_AMT + CLM_AMT - DPST_AMT AS AMT
            FROM CLTUR_PHSTRN_ACT_CT AS c2
            WHERE CLTUR_PHSTRN_ACT_MNG_YM = #{clturPhstrnActMngYm}
        ) AS c2 ON c1.EMP_ID = c2.EMP_ID
        JOIN EMP AS e ON c1.EMP_ID = e.EMP_ID
        SET
            c1.FTNESS_TRNG_CT_CYFD_AMT = c2.FTNESS,
            c1.CLTUR_CT_CYFD_AMT = c2.CLTUR,
            c1.CYFD_AMT = c2.AMT
        WHERE c1.CLTUR_PHSTRN_ACT_MNG_YM = #{nextMonth}
        AND e.HDOF_STTS_CD = 'VTW00301'
        AND e.EMP_TY_CD = 'VTW00201'
    </update>

    <!-- 문체비 지급금액 수정 -->
    <update id="saveDpstAmt" parameterType="map">
        UPDATE CLTUR_PHSTRN_ACT_CT
        SET
            CLTUR_CT_DPST_AMT =
                CASE
                    WHEN #{clturPhstrnSeCd} = 'VTW00901' THEN #{dpstAmt}
                    ELSE CLTUR_CT_DPST_AMT
                END,
            FTNESS_TRNG_CT_DPST_AMT =
                CASE
                    WHEN #{clturPhstrnSeCd} = 'VTW00902' THEN #{dpstAmt}
                    ELSE FTNESS_TRNG_CT_DPST_AMT
                END,
            DPST_AMT = (CLTUR_CT_DPST_AMT + FTNESS_TRNG_CT_DPST_AMT)
        WHERE EMP_ID = #{empId}
        AND CLTUR_PHSTRN_ACT_MNG_YM = #{ym}
    </update>

    <!-- 문체비 지급금액 수정: 익월 이월금액 -->
    <update id="saveDpstAmtNextMonth" parameterType="map">
        UPDATE CLTUR_PHSTRN_ACT_CT AS c1
        JOIN (
            SELECT
                EMP_ID,
                FTNESS_TRNG_CT_CYFD_AMT + FTNESS_TRNG_CT_CLM_AMT - FTNESS_TRNG_CT_DPST_AMT AS FTNESS,
                CLTUR_CT_CYFD_AMT + CLTUR_CT_CLM_AMT - CLTUR_CT_DPST_AMT AS CLTUR,
                CYFD_AMT + CLM_AMT - DPST_AMT AS AMT
            FROM CLTUR_PHSTRN_ACT_CT
            WHERE CLTUR_PHSTRN_ACT_MNG_YM = #{ym}
        ) AS c2 ON c1.EMP_ID = c2.EMP_ID
        SET
            c1.FTNESS_TRNG_CT_CYFD_AMT = c2.FTNESS,
            c1.CLTUR_CT_CYFD_AMT = c2.CLTUR,
            c1.CYFD_AMT = c2.AMT
        WHERE c1.CLTUR_PHSTRN_ACT_MNG_YM = #{nextMonth}
        AND c1.EMP_ID = #{empId}
    </update>

    <!-- 문체비 관리 목록 -->
    <select id="retrieveClturPhstrnCtClmList" parameterType="map" resultType="com.trsystem.LowerHashMap">
       SELECT
            C.EMP_ID,
            C.EMP_FLNM,
            C.JBPS_CD,
            C.YM,
            C.EXPENSE_TYPE,
            C.CLTUR_PHSTRN_SE_CD,
            C.CYFD_AMT,
            C.CLM_AMT,
            C.DPST_AMT,
            C.BALANCE,
            C.DPST_YMD
       FROM (
            SELECT
                e.EMP_ID,
                e.JBPS_CD,
                CONCAT('(', e.EMPNO, ')', ' ', e.EMP_FLNM) AS EMP_FLNM,
                e.YM AS YM,
                '문화비' AS EXPENSE_TYPE,
                'VTW00901' AS CLTUR_PHSTRN_SE_CD,
                IFNULL(cpac.CLTUR_CT_CYFD_AMT, 0) AS CYFD_AMT,
                IFNULL(cpac.CLTUR_CT_CLM_AMT, 0) AS CLM_AMT,
                IFNULL(cpac.CLTUR_CT_DPST_AMT, 0) AS DPST_AMT,
                IFNULL(cpac.CLTUR_CT_CYFD_AMT, 0) + IFNULL(cpac.CLTUR_CT_CLM_AMT, 0) - IFNULL(cpac.CLTUR_CT_DPST_AMT, 0) AS BALANCE,
                cpac.CLTUR_CT_DPST_YMD AS DPST_YMD
            FROM (
                SELECT
                    e.EMP_ID,
                    e.EMP_FLNM,
                    e.EMPNO,
                    e.JBPS_CD,
                    #{clturPhstrnActMngYm} AS YM
                FROM EMP e
                WHERE 1=1
                  AND (#{empFlnm} IS NULL OR e.EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%'))
                  AND (#{empno} IS NULL OR e.EMPNO LIKE CONCAT('%', #{empno}, '%'))
                  AND e.HDOF_STTS_CD ='VTW00301'
                  AND e.EMP_TY_CD = 'VTW00201'
                  AND e.EMPNO NOT IN ('VK0101', 'VK0102', 'VK0103', 'VK0104', 'VK0105', 'VK0106', 'VK0107', 'VK0108', 'VK0109', 'VK0110', 'VM1000')
            ) e
            LEFT JOIN CLTUR_PHSTRN_ACT_CT cpac ON cpac.EMP_ID = e.EMP_ID AND cpac.CLTUR_PHSTRN_ACT_MNG_YM = e.YM
            GROUP BY EMP_ID, EMPNO, EMP_FLNM, YM
            UNION ALL
            SELECT
                e.EMP_ID,
                e.JBPS_CD,
                CONCAT('(', e.EMPNO, ')', ' ', e.EMP_FLNM) AS EMP_FLNM,
                e.YM AS YM,
                '체력단련비' AS EXPENSE_TYPE,
                'VTW00902' AS CLTUR_PHSTRN_SE_CD,
                IFNULL(cpac.FTNESS_TRNG_CT_CYFD_AMT, 0) AS CYFD_AMT,
                IFNULL(cpac.FTNESS_TRNG_CT_CLM_AMT, 0) AS CLM_AMT,
                IFNULL(cpac.FTNESS_TRNG_CT_DPST_AMT, 0) AS DPST_AMT,
                IFNULL(cpac.FTNESS_TRNG_CT_CYFD_AMT, 0) + IFNULL(cpac.FTNESS_TRNG_CT_CLM_AMT, 0) - IFNULL(cpac.FTNESS_TRNG_CT_DPST_AMT, 0) AS BALANCE,
                cpac.FTNESS_TRNG_CT_DPST_YMD AS DPST_YMD
            FROM (
                 SELECT
                     e.EMP_ID,
                     e.EMP_FLNM,
                     e.EMPNO,
                     e.JBPS_CD,
                     #{clturPhstrnActMngYm} AS YM
                 FROM EMP e
                 WHERE 1=1
                   AND (#{empFlnm} IS NULL OR e.EMP_FLNM LIKE CONCAT('%', #{empFlnm}, '%'))
                   AND (#{empno} IS NULL OR e.EMPNO LIKE CONCAT('%', #{empno}, '%'))
                   AND e.EMP_TY_CD = 'VTW00201'
                   AND e.HDOF_STTS_CD ='VTW00301'
                   AND e.EMPNO NOT IN ('VK0101', 'VK0102', 'VK0103', 'VK0104', 'VK0105', 'VK0106', 'VK0107', 'VK0108', 'VK0109', 'VK0110', 'VM1000')
            ) e
            LEFT JOIN CLTUR_PHSTRN_ACT_CT cpac ON cpac.EMP_ID = e.EMP_ID AND cpac.CLTUR_PHSTRN_ACT_MNG_YM = e.YM
            GROUP BY EMP_ID, EMPNO, EMP_FLNM, YM
       ) C
       ORDER BY C.JBPS_CD, C.EXPENSE_TYPE
    </select>

    <select id="retrieveCtData" parameterType="map" resultType="com.trsystem.LowerHashMap">
        SELECT
            pca.PRJCT_CT_APLY_SN,
            pca.PRJCT_ID
        FROM PRJCT_CT_APLY pca
        JOIN PRJCT_CT_ATRZ pcat ON pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN
            AND pca.PRJCT_ID = pcat.PRJCT_ID
            AND pca.EMP_ID = pcat.EMP_ID
            AND pca.APLY_YM = pcat.APLY_YM
            AND pca.APLY_ODR = pcat.APLY_ODR
		WHERE 1=1
	        AND (pca.CT_STLM_SE_CD = 'VTW01902' OR pca.CT_STLM_SE_CD = 'VTW01903')
		    AND pca.EMP_ID = #{empId}
		    AND pca.APLY_YM = #{aplyYm}
		    AND pca.APLY_ODR = #{aplyOdr}
		    AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
	</select>
    
    <select id="retrieveCtPivotData" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT CONCAT(p.PRJCT_NM, '(', p.PRJCT_CD_IDNTFR , ')') PRJCT_NM_CD
            , c1.CD_NM AS CT_STLM_SE_CD_NM
			, c2.CD_NM AS EXPENS_CD_NM
			, CONCAT(IFNULL(SUBSTRING(cd.CRTR_YMD, 7, 8), SUBSTRING(LEFT(pca.UTZTN_DT, 8), 7, 8)), pca.CT_PRPOS) AS CT_PRPOS
			, pca.ATDRN
			, pca.UTZTN_AMT
			, IFNULL(SUBSTRING(cd.CRTR_YMD, 7, 8), '기타') AS DAY
		FROM PRJCT_CT_APLY pca
		JOIN PRJCT p ON (pca.PRJCT_ID = p.PRJCT_ID)
		JOIN CD c1 ON (c1.CD_VALUE = pca.CT_STLM_SE_CD)
		JOIN CD c2 ON (c2.CD_VALUE = pca.EXPENS_CD)
		LEFT JOIN CRTR_DATE cd ON (cd.CRTR_YMD LIKE CONCAT(pca.APLY_YM, '%') AND cd.CRTR_ODR = pca.APLY_ODR AND LEFT(pca.UTZTN_DT, 8) = cd.CRTR_YMD)
        JOIN PRJCT_CT_ATRZ pcat ON pcat.PRJCT_CT_APLY_SN = pca.PRJCT_CT_APLY_SN
            AND pca.PRJCT_ID = pcat.PRJCT_ID
            AND pca.EMP_ID = pcat.EMP_ID
            AND pca.APLY_YM = pcat.APLY_YM
            AND pca.APLY_ODR = pcat.APLY_ODR
		WHERE 1=1
		    AND pca.EMP_ID = #{empId}
		    AND pca.APLY_YM = #{aplyYm}
		    AND pca.APLY_ODR = #{aplyOdr}
		    AND (pca.CT_STLM_SE_CD = 'VTW01902' OR pca.CT_STLM_SE_CD = 'VTW01903')	-- 현금/개인법인카드
		    AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
		UNION
		SELECT CONCAT(p.PRJCT_NM, '(', p.PRJCT_CD_IDNTFR , ')') PRJCT_NM_CD
	        , c1.CD_NM AS CT_STLM_SE_CD_NM
			, c2.CD_NM AS EXPENS_CD_NM
			, CONCAT(SUBSTRING(LEFT(pca.UTZTN_DT, 8), 7, 8), pca.CT_PRPOS) AS CT_PRPOS
			, pca.ATDRN
            , CASE WHEN LEFT(pca.UTZTN_DT, 8) = cd.CRTR_YMD THEN pca.UTZTN_AMT
			    ELSE NULL
			END AS UTZTN_AMT
		 	, IFNULL(SUBSTRING(cd.CRTR_YMD, 7, 8), SUBSTRING(LEFT(pca.UTZTN_DT, 8), 7, 8)) AS DAY
		FROM CRTR_DATE cd
		JOIN PRJCT_CT_APLY pca
		JOIN PRJCT p ON p.PRJCT_ID = pca.PRJCT_ID
		JOIN CD c1 ON (c1.CD_VALUE = pca.CT_STLM_SE_CD)
		JOIN CD c2 ON (c2.CD_VALUE = pca.EXPENS_CD)
		WHERE 1=1
		    AND cd.CRTR_YMD LIKE CONCAT(#{aplyYm},'%')
		    AND cd.CRTR_ODR = #{aplyOdr}
		    AND pca.PRJCT_CT_APLY_SN = #{prjctCtAplySn}
   		    AND pca.EMP_ID = #{empId}
		    AND pca.APLY_YM = #{aplyYm}
		    AND pca.APLY_ODR = #{aplyOdr}
		    AND pca.PRJCT_ID = #{prjctId}
	</select>

    <select id="getWorkDay" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT CRTR_YMD 
		  FROM CRTR_DATE cd
		 WHERE 1=1
		   AND CRTR_YMD LIKE CONCAT(#{aplyYm}, '%') 
		   AND CRTR_ODR = #{aplyOdr}
	</select>
	
    <select id="retrieveDdlnYn" parameterType="map" resultType="com.trsystem.LowerHashMap">
		  SELECT DISTINCT (DDLN_YN) AS DDLN_YN
		  FROM CRTR_DATE cd
		 WHERE 1=1
		   AND SUBSTR(CRTR_YMD, 1, 6) = #{aplyYm}
		   AND CRTR_ODR = #{aplyOdr}
	</select>
	
    <select id="retrieveClosingList" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT e.EMP_ID
			 , cd.CD_NM AS BANK_CD_NM
			 , e.ACTNO
			 , SUM(pca.UTZTN_AMT) AS SUM_UTZTN_AMT
			 , e.EMP_FLNM
			 , CONCAT(pca.APLY_YM, '-', pca.APLY_ODR, ' TR') AS TR
		  FROM EMP e
		  JOIN PRJCT_CT_APLY pca 
		    ON (pca.EMP_ID = e.EMP_ID)
		  JOIN PRJCT_CT_ATRZ pcat
		    ON (
		    	pca.EMP_ID = pcat.EMP_ID 
		    AND pca.PRJCT_ID = pcat.PRJCT_ID 
		    AND pca.APLY_YM = pcat.APLY_YM 
		    AND pca.APLY_ODR = pcat.APLY_ODR 
		    AND pca.PRJCT_CT_APLY_SN = pcat.PRJCT_CT_APLY_SN
		    )
		  LEFT JOIN CD cd
		    ON (cd.CD_VALUE = e.BANK_CD)
		 WHERE pca.APLY_YM = #{aplyYm}
		   AND pca.APLY_ODR = #{aplyOdr}
		   AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
		   AND (pca.CT_STLM_SE_CD = 'VTW01902' OR pca.CT_STLM_SE_CD = 'VTW01903')
		GROUP BY e.EMP_ID, BANK_CD_NM, e.ACTNO, e.EMP_FLNM
	</select>
	
	<select id="updateDdlnYn" parameterType="map" resultType="com.trsystem.LowerHashMap">
		UPDATE CRTR_DATE
		   SET DDLN_YN = #{ddlnYn}
		 WHERE 1=1
		   AND CRTR_ODR = #{aplyOdr}
		   AND SUBSTR(CRTR_YMD, 1, 6) = #{aplyYm}
	</select>


    <!-- 문화체육활동비용등록수정 -->
    <update id="updateClturPhstrnActctReg" parameterType="map">
        /* financialAffairMngMapper.updateClturPhstrnActctReg */
        UPDATE CLTUR_PHSTRN_ACT_CT_REG
        SET
            CLTUR_PHSTRN_SE_CD = #{clturPhstrnSeCd}
            ,CLM_AMT = #{clmAmt}
            ,RM = #{rm}
            ,REG_DT = SYSDATE()
            ,REG_EMP_ID = #{sessionEmpId}
        WHERE EMP_ID = #{empId}
        AND CLTUR_PHSTRN_ACT_CT_SN = #{clturPhstrnActCtSn}
    </update>

	
	<select id="retrieveMmList" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT pma.PRJCT_ID
			 , p.PRJCT_NM
			 , pma.EMP_ID
			 , pma.APLY_YM
			 , pma.APLY_ODR
			 , pma.APLY_YMD
		 	 , CONCAT(pma.MD * 8, ' hrs') AS MD
		  FROM PRJCT_MM_APLY pma
		  JOIN PRJCT_MM_ATRZ pmat
		    ON (
		    	pma.PRJCT_ID = pmat.PRJCT_ID 
		   		AND pma.EMP_ID = pmat.EMP_ID 
		   		AND pma.APLY_YM = pmat.APLY_YM 
		   		AND pma.APLY_ODR = pmat.APLY_ODR
		   		AND pma.APLY_YMD = pmat.APLY_YMD
		   	   )
          JOIN PRJCT p 
    	    ON p.PRJCT_ID = pma.PRJCT_ID
		 WHERE 1=1
		   AND pma.EMP_ID = #{empId}
		   AND pma.APLY_YM = #{aplyYm}
		   AND pma.APLY_ODR = #{aplyOdr}
	       AND pmat.ATRZ_DMND_STTS_CD = 'VTW03703'
	</select>
	
	<select id="retrieveCtList" parameterType="map" resultType="com.trsystem.LowerHashMap">
		SELECT pca.PRJCT_ID
			 , p.PRJCT_NM
			 , cd1.CD_NM AS EXPENS_CD_NM
			 , cd2.CD_NM AS CT_STLM_SE_CD_NM
			 , pca.CT_PRPOS
			 , pca.USE_OFFIC 
			 , DATE_FORMAT(pca.UTZTN_DT, '%Y-%m-%d') AS UTZTN_DT
			 , pca.UTZTN_AMT
			 , pca.PRJCT_CT_APLY_SN
			 , pca.APLY_YM
			 , pca.APLY_ODR
			 , pca.EMP_ID
		  FROM PRJCT_CT_APLY pca
		  JOIN PRJCT_CT_ATRZ pcat
		    ON (
		  	   pca.PRJCT_ID = pcat.PRJCT_ID
		  	   AND pca.APLY_YM = pcat.APLY_YM 
		  	   AND pca.APLY_ODR = pcat.APLY_ODR
		  	   AND pca.PRJCT_CT_APLY_SN = pcat.PRJCT_CT_APLY_SN
		  	   AND pca.EMP_ID = pcat.EMP_ID
		  	   )
		  JOIN PRJCT p
		    ON p.PRJCT_ID = pca.PRJCT_ID
		  JOIN CD cd1
		    ON cd1.CD_VALUE = pca.EXPENS_CD
		  JOIN CD cd2
		    ON cd2.CD_VALUE = pca.CT_STLM_SE_CD
		 WHERE 1=1
		   AND pcat.ATRZ_DMND_STTS_CD = 'VTW03703'
		   AND pca.ELCTRN_ATRZ_ID IS NULL
		   AND pca.APLY_YM = #{aplyYm}
		   AND pca.APLY_ODR = #{aplyOdr}
		   AND pca.EMP_ID = #{empId}
	</select>
	
</mapper>